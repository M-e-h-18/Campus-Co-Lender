<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Co-Lender Homepage</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>

    <!-- Navigation Bar -->

<nav class="navbar">
    <h1>üõí My Shop</h1>
    <div class="nav-links">
        {% if current_user.is_authenticated %}
        
        <!-- User Dropdown Menu -->
        <div class="user-menu">
            <button class="user-btn" onclick="toggleDropdown()">
                {{ current_user.username }} ‚¨á
            </button>
            <ul class="user-dropdown" id="user-dropdown">
                <li><a href="{{ url_for('interest.get_interested_products') }}">‚ù§Ô∏è Interested</a></li>
                <li><a href="{{ url_for('cart.get_cart') }}">üõí My Cart</a></li>
                <li><a href="{{ url_for('interest.my_listings') }}">üì¶ My Listings</a></li>
                <li><a href="{{ url_for('messages.inbox') }}">üì© Inbox</a></li>
                <li><a href="{{ url_for('auth.logout') }}">üö™ Logout</a></li>
            </ul>
        </div>

        {% else %}
        <!-- Guest User -->
        <a href="{{ url_for('auth.login') }}" class="btn btn-outline-primary">üõí My Cart</a>
        <a href="{{ url_for('interest.get_interested_products') }}" class="btn btn-outline-danger">‚ù§Ô∏è Interested</a>
        <a href="{{ url_for('auth.login') }}" class="login-btn">Login</a>
        <a href="{{ url_for('auth.register') }}" class="register-btn">Register</a>
        {% endif %}
    </div>
</nav>




    <!-- Hero Section -->
    <header class="hero">
        <h2>Welcome to the Best Campus Trading Place</h2>
    </header>

    <!-- Search Bar with Filter and Sort Buttons -->
<div class="search-container">
    <div class="filter-dropdown">
        <button class="filter-btn" onclick="toggleCategoryFilter()">Filter ‚ñº</button>
        <select id="category-select" class="category-dropdown" onchange="searchProducts()">
            <option value="">All Categories</option>
        </select>
    </div>
    
    <!-- Sort Dropdown -->
    <select id="sort-select" class="sort-dropdown">
        <option value="">Sort By</option>
        <option value="interested_desc">Most Interested</option>
        <option value="price_asc">Price: Low to High</option>
        <option value="price_desc">Price: High to Low</option>
    </select>

    <input type="text" id="search-box" placeholder="Search for products...">
    <button onclick="searchProducts()" class="search-btn">Search</button>
</div>

    <!-- Category Filter -->
    <div id="category-filter" class="category-filter" style="display: none;">
        <label for="category-select">Category:</label>
        <select id="category-select">
            <option value="">All Categories</option>
        </select>
    </div>

    <!-- Available Products -->
    <h2 class="section-title">Available Products</h2>
    <div id="products" class="products-grid"></div>

    <a href="{{ url_for('products.add_listing') }}" class="floating-btn">‚ûï Add Listing</a>
    
    <script>
        window.onload = function() {
            setTimeout(loadAllProducts, 500);  // Load all products initially
            fetchCategories();
            updateUnreadMessages();
        };
        document.getElementById("category-select").addEventListener("change", searchProducts);
        document.getElementById("sort-select").addEventListener("change", loadAllProducts);
     
    function toggleDropdown() {
        let dropdown = document.getElementById("user-dropdown");
        dropdown.style.display = (dropdown.style.display === "block") ? "none" : "block";
    }

    // Close dropdown when clicking outside
    document.addEventListener("click", function(event) {
        let dropdown = document.getElementById("user-dropdown");
        let button = document.querySelector(".user-btn");

        if (!dropdown.contains(event.target) && !button.contains(event.target)) {
            dropdown.style.display = "none";
        }
    });

        function fetchCategories() {
    fetch('/products/categories')
        .then(response => response.json())
        .then(data => {
            let categorySelect = document.getElementById('category-select');

            // ‚úÖ Clear previous options
            categorySelect.innerHTML = '<option value="">All Categories</option>';

            // ‚úÖ Populate dropdown
            data.categories.forEach(category => {
                let option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });

            console.log("Categories Loaded:", data.categories);  // ‚úÖ Debugging

            // ‚úÖ Attach change event AFTER dropdown is populated
            categorySelect.addEventListener("change", searchProducts);
        })
        .catch(error => console.error("Error fetching categories:", error));
}


        function loadAllProducts() {
    let sortOption = document.getElementById("sort-select").value;
    let selectedCategory = document.getElementById("category-select").value;
    
    let url = "/products/all";
    let params = [];

    if (sortOption) {
        params.push(`sort=${sortOption}`);
    }
    if (selectedCategory) {
        params.push(`category=${selectedCategory}`);
    }

    if (params.length > 0) {
        url += "?" + params.join("&");
    }

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error("Failed to load products.");
            }
            return response.json();
        })
        .then(data => {
            displayProducts(data);
        })
        .catch(error => console.error("Error loading products:", error));
}

// Ensure the sort dropdown reloads products when changed
document.getElementById("sort-select").addEventListener("change", loadAllProducts);
document.getElementById("category-select").addEventListener("change", loadAllProducts);



function searchProducts() {
    let query = document.getElementById("search-box").value.trim();
    let selectedCategory = document.getElementById("category-select").value;
    let params = new URLSearchParams();

    if (query) params.append("query", query);
    if (selectedCategory) params.append("category", selectedCategory);

    let url = "/products/search";
    if (params.toString()) url += "?" + params.toString();

    console.log("Search URL:", url); // ‚úÖ Debugging

    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log("Fetched Products:", data); // ‚úÖ Debugging
            displayProducts(data);
        })
        .catch(error => console.error("Error fetching products:", error));
}

        function displayProducts(products) {
            let productsDiv = document.getElementById("products");
            productsDiv.innerHTML = "";

            if (products.length === 0) {
                productsDiv.innerHTML = "<p>No products found.</p>";
                return;
            }

            products.forEach(product => {
                let imageUrl = `/static/uploads/${product.image_filename}`;
                let productUrl = `/products/product/${product.id}`;
                productsDiv.innerHTML += `
                    <a href="${productUrl}" class="product-card">
                        <img src="${imageUrl}" alt="${product.name}" class="product-image">
                        <h3>${product.name}</h3>
                        <p>Price: Rs.${product.price}</p>
                    </a>`;
            });
        }
        /*function loadTrendingProducts() {
        fetch("/products/trending")
            .then(response => response.json())
            .then(data => {
                displayProducts(data, "trending-products");
            })
            .catch(error => console.error("Error loading trending products:", error));
    }
    window.onload = function() {
        loadTrendingProducts();  // Load trending products on page load
    };*/
        function updateUnreadMessages() {
            fetch("/unread_count")
                .then(response => response.json())
                .then(data => {
                    let unreadCount = data.unread_count;
                    let badge = document.getElementById("unread-count");

                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = "inline-block";
                    } else {
                        badge.style.display = "none";
                    }
                })
                .catch(error => console.error("Error fetching unread messages:", error));
        }

        setInterval(updateUnreadMessages, 5000);

        function toggleCategoryFilter() {
    let filterDropdown = document.querySelector(".filter-dropdown");
    filterDropdown.classList.toggle("active");
}


    </script>

</body>
</html>
